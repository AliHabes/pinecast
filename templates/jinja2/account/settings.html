{% extends 'dashboard/base.html' %}
{% block dashboard_body %}

<header>
  <h1>{{ _('Account Settings') }}</h1>
</header>

<div class="card card-block" id="as-section-profile">
  <strong>{{ _('Account') }}</strong>

  <div class="user-detail">
    <img src="{{ gravatar(user.email) }}" alt="">

    <dl class="user-detail-list">
      <dt>{{ _('Email') }}</dt>
      <dd>
        {{ user.email }}
        <a href="#as-section-email">{{ _('(change)') }}</a>
      </dd>

      <dt>{{ _('Account Created') }}</dt>
      <dd><abbr title="{{ user.date_joined }}">{{ user.date_joined|pretty_date }}</abbr></dd>

    </dl>
  </div>

  <p>{{ _('To change your avatar, please visit {startlink}Gravatar{endlink}.').format(startlink='<a href="https://gravatar.com/">', endlink='</a>')|safe }}</p>
</div>

{% if success == 'tz' %}
  <div class="success">
    {{ _('Your timezone was updated successfully.') }}
  </div>
{% elif success == 'em' %}
  <div class="success">
    {{ _('We have sent the confirmation email. Please check your inbox.') }}
  </div>
{% elif success == 'emf' %}
  <div class="success">
    {{ _('Your email address has been updated') }}
  </div>
{% endif %}

{% if error == 'eae' %}
  <div class="error">
    {{ _('That email address is already in use.') }}
  </div>
{% elif error == 'pwo' %}
  <div class="error">
    {{ _('The password that you entered did not match the password we have on file.') }}
  </div>
{% elif error == 'pwc' %}
  <div class="error">
    {{ _('Your passwords did not match. Try again.') }}
  </div>
{% elif error == 'pwl' %}
  <div class="error">
    {{ _('The password you chose was not long enough. Passwords must be at least eight characters.') }}
  </div>
{% endif %}

<div class="card card-block" id="as-section-timezone">
  <strong>{{ _('Timezone') }}</strong>

  <form action="{{ url('user_settings_save_tz') }}" method="post">

    <label>
      <span>{{ _('Selected Timezone') }}</span>
      <select name="timezone">
        {% for tz in timezones %}
          <option{{ ' selected' if user_settings.tz_offset == tz_offset(tz) else '' }}>{{ tz }}</option>
        {% endfor %}
      </select>
    </label>

    <menu class="toolbar">
      <button type="submit">{{ _('Save Timezone') }}</button>
    </menu>

    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
  </form>
</div>

<div class="card card-block" id="as-section-pw">
  <strong>{{ _('Change Password') }}</strong>

  <form action="{{ url('user_settings_change_password') }}" method="post">

    <p>{{ _('Passwords must be at least eight characters.') }}</p>

    <label>
      <span>{{ _('Old Password') }}</span>
      <input required type="password" name="old_password">
    </label>

    <label>
      <span>{{ _('New Password') }}</span>
      <input required type="password" name="new_password" minlength="8">
    </label>

    <label>
      <span>{{ _('Confirm Password') }}</span>
      <input required type="password" name="confirm_password">
    </label>

    <menu class="toolbar">
      <button type="submit">{{ _('Change Password') }}</button>
    </menu>

    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
  </form>
</div>

<div class="card card-block" id="as-section-email">
  <strong>{{ _('Change Email') }}</strong>

  <form action="{{ url('user_settings_change_email') }}" method="post">

    <p>
      {% trans %}
        To change your email on file, enter your new email address. Then, check
        your inbox for an email with a link to finalize the switch.
      {% endtrans %}
    </p>

    <label>
      <span>{{ _('New Email') }}</span>
      <input type="email" name="new_email" placeholder="me@pinecast.com">
    </label>

    <menu class="toolbar">
      <button type="submit">{{ _('Change Email') }}</button>
    </menu>

    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
  </form>
</div>

<div class="card card-block" id="bank-account-details">
  <strong>{{ _('Bank Account') }}</strong>

  <p>
    {% trans %}By adding bank account details to Pinecast, you can begin accepting tips for your podcasts.{% endtrans %}
  </p>

  {% if user_settings.stripe_payout_managed_account %}
    {% set existing_acc = user_settings.get_account_info() %}
    <p>
      {% trans holder_name=existing_acc['name'],
               bank_name=existing_acc['bank_name'] %}
        A bank account has already been associated with this account belonging to <b>{{ holder_name }}</b> with <b>{{ bank_name }}</b>.
      {% endtrans %}
  {% endif %}
  <div class="bank-info-form"
      data-has-existing="{{ 'true' if user_settings.stripe_payout_managed_account else 'false'}}"
      data-publishable-key="{{ STRIPE_PUBLISHABLE_KEY }}"></div>
  <p>
    {% trans %}By adding or updating bank account information, you agree to Stripe's <a href="https://stripe.com/connect/account-terms">Connected Account Agreement</a>.{% endtrans %}
  </p>
</div>

<div class="card card-block" id="as-section-cc">
  <strong>{{ _('Credit Card') }}</strong>

  {% if user_settings.has_payment_method() %}
    {% set existing_card = user_settings.get_card_info() %}
    <p>
      {% trans last_four=existing_card['lastFour'],
               month=existing_card['expiration']['month'],
               year=existing_card['expiration']['year'] %}
        A card exists with the last four digits "{{ last_four }}" and the
        expiration {{ month }}/{{ year }}.
      {% endtrans %}
    </p>
    <p>{{ _('You can use the form below to add a new payment method.') }}</p>
  {% endif %}

  <div class="payment-info-form" data-publishable-key="{{ STRIPE_PUBLISHABLE_KEY }}"></div>
</div>

{% endblock %}

{% block after_content %}
<script src="https://js.stripe.com/v2/"></script>
<script src="/static/js/ui-cc.js"></script>
<script src="/static/js/ui-bank.js"></script>
{% endblock %}
