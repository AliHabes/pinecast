{% extends 'dashboard_base.html' %}
{% block dashboard_body %}
<div class="breadcrumb">
  <a href="{{ url('podcast_dashboard', kwargs={'podcast_slug': podcast.slug}) }}">&laquo; Back to {{ podcast.name }}</a>
</div>
<h1>Edit {{ podcast.name }}</h1>

{% if error %}
<div class="error">
  Please check that all fields are filled out correctly.
</div>
{% endif %}

<form action="?" method="post">
  <label>
    <span>Name</span>
    <input type="text"
      name="name"
      placeholder="My Great Podcast"
      required
      maxlength="256"
      class="width-full"
      value="{{ default.get('name', podcast.name) }}">
  </label>
  <label>
    <span>Slug</span>
    <input type="text"
      name="slug"
      placeholder="my-great-podcast"
      required
      maxlength="64"
      pattern="[\w-]+"
      class="slug-field width-full"
      value="{{ default.get('slug', podcast.slug) }}">
    <div class="url-availability"></div>
    <div class="warning slug-warning">
      WARNING! Changing your slug will change your RSS feed URL. You will lose all of your subscribers.
    </div>
  </label>
  <label>
    <span>Subtitle</span>
    <input type="text"
      name="subtitle"
      placeholder="You'll never believe it"
      maxlength="512"
      value="{{ default.get('subtitle', podcast.subtitle) }}">
  </label>
  <label>
    <span>Description</span>
    <textarea name="description">{{ default.get('description', podcast.description)|safe }}</textarea>
  </label>
  <label>
    <input type="checkbox" name="is_explicit" value="true" {{ 'checked' if default.get('is_explicit', 'true' if podcast.is_explicit else 'false') == 'true' }}>
    <span>Explicit?</span>
  </label>
  <label>
    <span>Homepage</span>
    <input type="url" name="homepage" placeholder="https://my-great-podcast.biz" required value="{{ default.get('homepage', podcast.homepage) }}">
  </label>
  <label>
    <span>Language</span>
    <input type="text" name="language" placeholder="en-US" required maxlength="16" value="{{ default.get('language', podcast.language)}}">
  </label>
  <label>
    <span>Copyright</span>
    <input type="text"
      name="copyright"
      maxlength="1024"
      placeholder="Copyright 2015 Foo Bar Inc."
      required
      value="{{ default.get('copyright', podcast.copyright) }}">
  </label>
  <label>
    <span>Author</span>
    <input type="text"
      name="author_name"
      maxlength="1024"
      placeholder="Jane Doe"
      required
      value="{{ default.get('author_name', podcast.author_name) }}">
  </label>
  <div class="label">
    <span>Image</span>
    <div class="upload-placeholder"
      data-default-url="{{ default.get('image-url', podcast.cover_image) }}"
      data-default-size="{{ default.get('image-url-size') }}"
      data-default-name="{{ default.get('image-url-name') }}"
      data-default-type="{{ default.get('image-url-type') }}"
      data-accept="image/*"
      data-name="image-url"
      data-type="image"
      data-podcast="$none"></div>
  </div>

  <menu class="toolbar">
    <li><button type="submit">Save</button></li>
  </menu>

  <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
</form>

{% endblock %}

{% block after_content %}
<script src="https://fb.me/react-0.13.3.js"></script>
<script src="/static/js/nicEdit.js"></script>
<script src="/static/js/ui-uploader.js"></script>
<script>
nicEditors.allTextAreas();

(function() {
  var slugField = document.querySelector('.slug-field');
  var urlAvail = document.querySelector('.url-availability');
  
  var slugDebounce;
  var slugXHR;

  slugField.addEventListener('input', function() {
    if (slugDebounce) clearTimeout(slugDebounce);
    if (slugXHR) slugXHR.abort();
    if (!slugField.validity.valid) {
      urlAvail.textContent = urlAvail.innerText = '';
      urlAvail.className = 'url-availability';
      return;
    }
    slugDebounce = setTimeout(validateSlug, 500);
  });

  function validateSlug() {
    var xhr = new XMLHttpRequest();
    xhr.onload = function() {
      slugXHR = null;
      var parsed = JSON.parse(xhr.responseText);
      if (parsed.valid) {
        urlAvail.textContent = urlAvail.innerText = '"' + slugField.value + '" is available!';
        urlAvail.className = 'url-availability is-available';
      } else {
        urlAvail.textContent = urlAvail.innerText = '"' + slugField.value + '" is unavailable';
        urlAvail.className = 'url-availability is-unavailable';
      }
    };
    xhr.open('get', '/dashboard/services/slug_available?slug=' + encodeURIComponent(slugField.value), true);
    xhr.send();
    slugXHR = xhr;
  }

}());

</script>
{% endblock %}
